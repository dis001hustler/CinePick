<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="description" content="CinePick - Never wonder what to watch again. Your intelligent movie randomizer.">
  <meta name="theme-color" content="#0f0f0f">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="CinePick">
  
  <title>CinePick - Movie Randomizer</title>
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" sizes="192x192" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect fill='%23e50914' width='192' height='192'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-size='100' font-weight='bold' fill='white' font-family='Arial'>üé¨</text></svg>">
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect fill='%23e50914' width='180' height='180' rx='40'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-size='90' font-weight='bold' fill='white' font-family='Arial'>üé¨</text></svg>">
  
  <style>
    :root {
      --primary: #e50914;
      --primary-dark: #b20710;
      --bg-dark: #0f0f0f;
      --bg-card: rgba(255, 255, 255, 0.06);
      --bg-card-hover: rgba(255, 255, 255, 0.1);
      --text-primary: #ffffff;
      --text-secondary: #b0b0b0;
      --text-muted: #757575;
      --border: rgba(255, 255, 255, 0.08);
      --success: #10b981;
      --warning: #f59e0b;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      width: 100%;
      height: 100%;
      overflow-x: hidden;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
      background: var(--bg-dark);
      color: var(--text-primary);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      position: relative;
    }

    /* Animated background gradient */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(ellipse at 20% 50%, rgba(229, 9, 20, 0.08) 0%, transparent 50%),
                  radial-gradient(ellipse at 80% 80%, rgba(229, 9, 20, 0.05) 0%, transparent 50%);
      pointer-events: none;
      z-index: 0;
    }

    .container {
      position: relative;
      z-index: 1;
      max-width: 1100px;
      margin: 0 auto;
      padding: 20px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Header */
    .header {
      text-align: center;
      margin-bottom: 40px;
      margin-top: 40px;
      animation: slideDown 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .header-title {
      font-size: clamp(2.5rem, 8vw, 4rem);
      font-weight: 900;
      letter-spacing: -0.02em;
      background: linear-gradient(135deg, #ff6b6b 0%, var(--primary) 50%, #ff8a80 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 8px;
      text-shadow: 0 0 20px rgba(229, 9, 20, 0.6), 
                   0 0 40px rgba(229, 9, 20, 0.4),
                   0 0 60px rgba(255, 107, 107, 0.3);
      filter: drop-shadow(0 0 20px rgba(229, 9, 20, 0.5));
    }

    .header-subtitle {
      font-size: 1rem;
      color: var(--text-secondary);
      font-weight: 300;
      letter-spacing: 0.05em;
      opacity: 0.9;
    }

    /* Main action card */
    .action-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 40px 20px;
      margin-bottom: 30px;
      backdrop-filter: blur(10px);
      animation: fadeInUp 0.8s ease 0.1s backwards;
      text-align: center;
    }

    .pick-button {
      font-size: 1.1rem;
      padding: 18px 50px;
      border: none;
      border-radius: 12px;
      font-weight: 700;
      cursor: pointer;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      position: relative;
      overflow: hidden;
      letter-spacing: 0.05em;
      box-shadow: 0 10px 30px rgba(229, 9, 20, 0.3);
      margin: 0 auto;
    }

    .pick-button:hover:not(:disabled) {
      transform: translateY(-3px);
      box-shadow: 0 15px 40px rgba(229, 9, 20, 0.5);
    }

    .pick-button:active:not(:disabled) {
      transform: translateY(-1px);
    }

    .pick-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .movie-count {
      margin-top: 16px;
      font-size: 0.95rem;
      color: var(--text-secondary);
    }

    .movie-count strong {
      color: var(--primary);
      font-weight: 600;
    }

    /* Result display */
    .result-section {
      margin-bottom: 30px;
      animation: fadeInUp 0.8s ease 0.2s backwards;
    }

    .result-box {
      background: linear-gradient(135deg, rgba(229, 9, 20, 0.15) 0%, rgba(229, 9, 20, 0.08) 100%);
      border: 2px solid var(--primary);
      border-radius: 16px;
      padding: 30px;
      text-align: center;
      min-height: 120px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .result-label {
      font-size: 0.85rem;
      color: var(--text-secondary);
      letter-spacing: 0.03em;
      margin-bottom: 12px;
      font-weight: 600;
    }

    .result-title {
      font-size: 2rem;
      font-weight: 800;
      color: var(--primary);
      word-break: break-word;
    }

    /* Loading spinner */
    .spinner {
      width: 50px;
      height: 50px;
      border: 3px solid rgba(255, 255, 255, 0.2);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Movie details panel */
    .details-panel {
      display: none;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 30px;
      backdrop-filter: blur(10px);
      margin-top: 20px;
      animation: fadeInUp 0.6s ease;
    }

    .details-panel.active {
      display: block;
    }

    .details-grid {
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 30px;
      margin-top: 20px;
    }

    .poster-container {
      display: flex;
      justify-content: center;
    }

    .poster-image {
      width: 100%;
      max-width: 280px;
      border-radius: 12px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
      border: 1px solid var(--border);
    }

    .poster-placeholder {
      width: 100%;
      max-width: 280px;
      height: 400px;
      background: var(--bg-card-hover);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid var(--border);
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    .details-content h3 {
      font-size: 1.8rem;
      color: var(--primary);
      margin-bottom: 20px;
      letter-spacing: -0.01em;
    }

    .info-row {
      display: flex;
      gap: 15px;
      margin-bottom: 16px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border);
      align-items: flex-start;
    }

    .info-label {
      font-weight: 700;
      color: var(--primary);
      min-width: 100px;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .info-value {
      color: var(--text-secondary);
      flex: 1;
      line-height: 1.6;
    }

    .rating-badge {
      display: inline-block;
      background: linear-gradient(135deg, #fcd34d 0%, #fbbf24 100%);
      color: #000;
      padding: 4px 10px;
      border-radius: 6px;
      font-weight: 700;
      margin-right: 8px;
      font-size: 0.85rem;
    }

    .genre-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 12px;
    }

    .genre-tag {
      background: rgba(229, 9, 20, 0.2);
      border: 1px solid rgba(229, 9, 20, 0.4);
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .plot-text {
      line-height: 1.8;
      color: var(--text-secondary);
      font-size: 0.95rem;
      margin-top: 12px;
    }

    .imdb-link {
      display: inline-block;
      margin-top: 20px;
      padding: 8px 16px;
      background: rgba(229, 9, 20, 0.1);
      border: 1px solid var(--primary);
      border-radius: 8px;
      color: var(--primary);
      text-decoration: none;
      font-weight: 600;
      font-size: 0.9rem;
      transition: all 0.3s ease;
    }

    .imdb-link:hover {
      background: rgba(229, 9, 20, 0.2);
      transform: translateY(-2px);
    }

    /* Section cards */
    .section-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 25px;
      margin-bottom: 20px;
      backdrop-filter: blur(10px);
      animation: fadeInUp 0.8s ease backwards;
    }

    .section-card:nth-child(3) { animation-delay: 0.2s; }
    .section-card:nth-child(4) { animation-delay: 0.3s; }
    .section-card:nth-child(5) { animation-delay: 0.4s; }

    .section-title {
      font-size: 1.3rem;
      font-weight: 700;
      margin-bottom: 16px;
      color: var(--text-primary);
      letter-spacing: -0.01em;
    }

    input, textarea {
      width: 100%;
      padding: 12px 16px;
      background: var(--bg-card-hover);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text-primary);
      font-family: inherit;
      font-size: 1rem;
      margin-bottom: 10px;
      transition: all 0.2s ease;
      outline: none;
    }

    input:focus, textarea:focus {
      border-color: var(--primary);
      background: rgba(229, 9, 20, 0.05);
    }

    textarea {
      resize: vertical;
      min-height: 100px;
    }

    /* Buttons */
    .button-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 12px;
    }

    button {
      padding: 10px 18px;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.95rem;
      letter-spacing: 0.02em;
      position: relative;
      overflow: hidden;
    }

    .button-primary {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(229, 9, 20, 0.2);
    }

    .button-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(229, 9, 20, 0.3);
    }

    .button-secondary {
      background: rgba(255, 255, 255, 0.08);
      color: var(--text-primary);
      border: 1px solid var(--border);
    }

    .button-secondary:hover:not(:disabled) {
      background: rgba(255, 255, 255, 0.12);
      border-color: rgba(255, 255, 255, 0.2);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Movie list */
    .movie-list {
      display: none;
      margin-top: 16px;
    }

    .movie-list.visible {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .movie-item {
      background: var(--bg-card-hover);
      border: 1px solid var(--border);
      padding: 8px 12px;
      border-radius: 8px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
      animation: slideIn 0.3s ease;
    }

    .movie-item button {
      padding: 2px 6px;
      font-size: 0.8rem;
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-secondary);
      border: none;
      margin: 0;
    }

    .movie-item button:hover {
      background: rgba(229, 9, 20, 0.3);
      color: var(--primary);
    }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 30px;
      color: var(--text-muted);
      font-style: italic;
    }

    /* Notifications */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 16px 20px;
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      z-index: 9999;
      animation: slideIn 0.3s ease;
      max-width: 300px;
      font-weight: 500;
      backdrop-filter: blur(10px);
      border: 1px solid var(--border);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    .notification.success,
    .notification.warning {
      opacity: 1;
      pointer-events: auto;
    }

    .notification.success {
      background: rgba(16, 185, 129, 0.15);
      color: #10b981;
      border-color: rgba(16, 185, 129, 0.3);
    }

    .notification.warning {
      background: rgba(245, 158, 11, 0.15);
      color: #f59e0b;
      border-color: rgba(245, 158, 11, 0.3);
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes slideDown {
      from {
        transform: translateY(-30px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    @keyframes fadeInUp {
      from {
        transform: translateY(20px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(4px);
      animation: fadeIn 0.3s ease;
    }

    .modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background: var(--bg-dark);
      border: 1px solid var(--border);
      padding: 30px;
      border-radius: 16px;
      width: 90%;
      max-width: 600px;
      max-height: 70vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(229, 9, 20, 0.3);
      animation: modalSlideIn 0.3s ease;
    }

    @keyframes modalSlideIn {
      from {
        transform: scale(0.9) translateY(20px);
        opacity: 0;
      }
      to {
        transform: scale(1) translateY(0);
        opacity: 1;
      }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary);
    }

    .modal-close {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .modal-close:hover {
      color: var(--primary);
      transform: rotate(90deg);
    }

    .movie-options {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 12px;
      margin-top: 16px;
    }

    .movie-option {
      background: var(--bg-card-hover);
      border: 2px solid var(--border);
      padding: 12px;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: center;
    }

    .movie-option:hover {
      border-color: var(--primary);
      background: rgba(229, 9, 20, 0.1);
      transform: translateY(-2px);
    }

    .movie-option-title {
      font-weight: 600;
      font-size: 0.9rem;
      margin-bottom: 6px;
      word-break: break-word;
    }

    .movie-option-year {
      color: var(--text-muted);
      font-size: 0.8rem;
    }

    /* Install prompt */
    .install-prompt {
      background: linear-gradient(135deg, rgba(229, 9, 20, 0.15) 0%, rgba(229, 9, 20, 0.08) 100%);
      border: 1px solid var(--primary);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
      display: none;
      align-items: center;
      gap: 16px;
      animation: slideDown 0.4s ease;
    }

    .install-prompt.visible {
      display: flex;
    }

    .install-prompt-text {
      flex: 1;
    }

    .install-prompt-title {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .install-prompt-subtitle {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .install-prompt button {
      white-space: nowrap;
      margin: 0;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .container {
        padding: 16px;
      }

      .header {
        margin-bottom: 30px;
      }

      .header-title {
        font-size: 2.5rem;
      }

      .action-card {
        padding: 30px 16px;
        margin-bottom: 24px;
      }

      .details-grid {
        grid-template-columns: 1fr;
        gap: 20px;
      }

      .movie-options {
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      }

      .notification {
        left: 10px;
        right: 10px;
        max-width: none;
      }

      .install-prompt {
        flex-direction: column;
        text-align: center;
      }

      .install-prompt button {
        width: 100%;
      }
    }

    @media (max-width: 480px) {
      .header-title {
        font-size: 2rem;
      }

      .result-title {
        font-size: 1.5rem;
      }

      .details-content h3 {
        font-size: 1.4rem;
      }

      .movie-options {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    /* Offline indicator */
    .offline-indicator {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: var(--warning);
      color: #000;
      padding: 12px 16px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 0.9rem;
      display: none;
      z-index: 999;
      animation: slideUp 0.3s ease;
    }

    .offline-indicator.visible {
      display: block;
    }

    @keyframes slideUp {
      from {
        transform: translateY(100px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
  </style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1 class="header-title">üé¨ CinePick</h1>
    <p class="header-subtitle">Can't decide what to watch? Let fate decide.</p>
  </div>

  <div class="install-prompt" id="installPrompt">
    <div class="install-prompt-text">
      <div class="install-prompt-title">Install CinePick</div>
      <div class="install-prompt-subtitle">Use offline. Works anywhere.</div>
    </div>
    <button class="button-primary" id="installBtn">Install App</button>
    <button class="button-secondary" id="dismissBtn" onclick="dismissInstallPrompt()">Dismiss</button>
  </div>

  <div class="action-card">
    <button class="pick-button" id="pickBtn" onclick="pickRandom()">Pick a Movie</button>
  </div>

  <div class="result-section" id="resultSection" style="display:none;">
    <div class="result-box" id="resultBox">
      <div>
        <div class="result-label">Now Watching:</div>
        <div class="result-title" id="resultTitle">Loading...</div>
      </div>
    </div>
  </div>

  <div class="details-panel" id="detailsPanel"></div>

  <!-- Add Movies Section -->
  <div class="section-card">
    <h2 class="section-title">Add Movies</h2>
    <input id="movieInput" placeholder="Search and add a movie..." onkeypress="if(event.key==='Enter') addMovie()">
    <div class="button-group">
      <button class="button-primary" onclick="addMovie()">Add Movie</button>
    </div>

    <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border);">
      <p style="color: var(--text-secondary); margin-bottom: 10px; font-size: 0.95rem;">Or paste multiple movies (one per line):</p>
      <textarea id="multiInput" placeholder="Paste movies here..."></textarea>
      <div class="button-group">
        <button class="button-primary" onclick="addMultiple()">Add Multiple</button>
      </div>
    </div>

    <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border);">
      <p style="color: var(--text-secondary); margin-bottom: 10px; font-size: 0.95rem;">Or import from a text file:</p>
      <input type="file" id="fileInput" accept=".txt" style="display:none;" onchange="importFromFile()">
      <div class="button-group">
        <button class="button-secondary" onclick="document.getElementById('fileInput').click()">Import .txt File</button>
      </div>
    </div>
  </div>

  <!-- Recently Added Section -->
  <div class="section-card" id="recentlyAddedSection" style="display: none;">
    <h2 class="section-title">Recently Added</h2>
    <div id="recentlyAddedList" style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px;"></div>
  </div>

  <!-- Your Movies Section -->
  <div class="section-card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
      <h2 class="section-title">Your Movies <span id="movieCountBadge" style="background: var(--primary); color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600;">0</span></h2>
    </div>
    <div class="button-group">
      <button class="button-primary" id="toggleBtn" onclick="toggleList()">Show Movies</button>
      <button class="button-secondary" id="undoBtn" onclick="undoDelete()" disabled>Undo</button>
      <button class="button-secondary" onclick="clearAllMovies()" id="clearBtn">Clear All</button>
    </div>

    <input id="searchInput" placeholder="üîç Search your movies..." oninput="render()" style="display:none; margin-top:12px;">
    <div id="movieList" class="movie-list"></div>
  </div>

  <!-- Backup & Restore Section -->
  <div class="section-card">
    <h2 class="section-title">Backup & Restore</h2>
    <div class="button-group">
      <button class="button-secondary" onclick="downloadBackup('json')">Download (.json)</button>
      <button class="button-secondary" onclick="downloadBackup('txt')">Download (.txt)</button>
      <input type="file" id="backupInput" accept=".json,.txt" style="display:none;" onchange="restoreFromBackup()">
      <button class="button-secondary" onclick="document.getElementById('backupInput').click()">Restore Backup</button>
    </div>
  </div>
</div>

<div class="notification" id="notification"></div>
<div class="offline-indicator" id="offlineIndicator">üì° Working offline</div>

<!-- Modal for version picker -->
<div id="movieModal" class="modal" onclick="if(event.target === this) closeModal()">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">Select Movie</h2>
      <button class="modal-close" onclick="closeModal()">‚úï</button>
    </div>
    <p style="color: var(--text-secondary); margin-bottom: 16px;">Choose which version you want to add:</p>
    <div id="movieOptions" class="movie-options"></div>
  </div>
</div>

<script>
  const API_KEY = "c8520fd6";
  const DB_NAME = "CinePick";
  const DB_VERSION = 1;
  const STORE_NAME = "movies";
  
  let db = null;
  let movies = [];
  let listVisible = false;
  let deletedMovies = [];
  let bulkQueue = [];
  let bulkAdded = [];
  let deferredPrompt = null;

  // Initialize IndexedDB
  async function initDB() {
    return new Promise((resolve, reject) => {
      const request = indexedDB.open(DB_NAME, DB_VERSION);
      
      request.onerror = () => {
        console.error("IndexedDB error:", request.error);
        reject(request.error);
      };
      
      request.onsuccess = () => {
        db = request.result;
        console.log("IndexedDB initialized");
        resolve(db);
      };
      
      request.onupgradeneeded = (event) => {
        const database = event.target.result;
        if (!database.objectStoreNames.contains(STORE_NAME)) {
          database.createObjectStore(STORE_NAME);
        }
      };
    });
  }

  // Load all movies from IndexedDB
  async function loadMoviesFromDB() {
    if (!db) return [];
    
    return new Promise((resolve, reject) => {
      const tx = db.transaction(STORE_NAME, "readonly");
      const store = tx.objectStore(STORE_NAME);
      const request = store.get("moviesList");
      
      request.onerror = () => reject(request.error);
      request.onsuccess = () => {
        const data = request.result;
        movies = data ? data.value : [];
        resolve(movies);
      };
    });
  }

  // Save movies to IndexedDB
  async function saveMoviesToDB() {
    if (!db) return;
    
    return new Promise((resolve, reject) => {
      const tx = db.transaction(STORE_NAME, "readwrite");
      const store = tx.objectStore(STORE_NAME);
      const request = store.put({ value: movies }, "moviesList");
      
      request.onerror = () => reject(request.error);
      request.onsuccess = () => resolve();
    });
  }

  // Register Service Worker
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js').catch(err => {
      console.log('Service Worker registration failed:', err);
    });
  }

  // PWA Install Prompt
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    document.getElementById('installPrompt').classList.add('visible');
  });

  document.getElementById('installBtn')?.addEventListener('click', async () => {
    if (deferredPrompt) {
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      console.log(`User response to the install prompt: ${outcome}`);
      deferredPrompt = null;
      dismissInstallPrompt();
    }
  });

  function dismissInstallPrompt() {
    document.getElementById('installPrompt').classList.remove('visible');
  }

  // Offline detection
  window.addEventListener('offline', () => {
    document.getElementById('offlineIndicator').classList.add('visible');
  });

  window.addEventListener('online', () => {
    document.getElementById('offlineIndicator').classList.remove('visible');
  });

  function saveMovies() {
    saveMoviesToDB().catch(err => {
      console.error("Error saving to IndexedDB:", err);
      // Fallback to localStorage if IndexedDB fails
      localStorage.setItem("movies", JSON.stringify(movies));
    });
  }

  // Normalize titles for comparison
  function normalizeTitle(title) {
    return title
      .toLowerCase()
      .replace(/^the\s+/, '') // Remove "The" at start
      .replace(/\s+the\s+/g, ' ') // Remove "The" in middle
      .replace(/[^\w\s]/g, '') // Remove punctuation
      .replace(/\s+/g, ' ') // Normalize spaces
      .trim();
  }

  // Calculate similarity between two strings (0-100)
  function calculateSimilarity(str1, str2) {
    const s1 = normalizeTitle(str1);
    const s2 = normalizeTitle(str2);
    
    if (s1 === s2) return 100;
    
    const longer = s1.length > s2.length ? s1 : s2;
    const shorter = s1.length > s2.length ? s2 : s1;
    
    if (longer.length === 0) return 100;
    
    const editDistance = getEditDistance(longer, shorter);
    return ((longer.length - editDistance) / longer.length) * 100;
  }

  // Levenshtein distance algorithm
  function getEditDistance(s1, s2) {
    const costs = [];
    for (let i = 0; i <= s1.length; i++) {
      let lastValue = i;
      for (let j = 0; j <= s2.length; j++) {
        if (i === 0) {
          costs[j] = j;
        } else if (j > 0) {
          let newValue = costs[j - 1];
          if (s1.charAt(i - 1) !== s2.charAt(j - 1)) {
            newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
          }
          costs[j - 1] = lastValue;
          lastValue = newValue;
        }
      }
      if (i > 0) costs[s2.length] = lastValue;
    }
    return costs[s2.length];
  }

  // Find duplicate or similar movies
  function findSimilarMovies(title) {
    return movies
      .map((movie, index) => ({
        movie,
        index,
        similarity: calculateSimilarity(title, movie)
      }))
      .filter(item => item.similarity >= 75) // 75%+ similarity
      .sort((a, b) => b.similarity - a.similarity);
  }

  function showNotification(message, type = 'success') {
    const notification = document.getElementById("notification");
    notification.textContent = message;
    notification.className = `notification ${type}`;
    setTimeout(() => {
      notification.className = '';
      notification.textContent = '';
    }, 3500);
  }

  function closeModal() {
    document.getElementById("movieModal").classList.remove('active');
  }

  async function checkForMultipleVersions(movieTitle) {
    try {
      const response = await fetch(`https://www.omdbapi.com/?s=${encodeURIComponent(movieTitle)}&apikey=${API_KEY}`);
      const data = await response.json();
      
      if (data.Response === "True" && data.Search && data.Search.length > 0) {
        return data.Search.slice(0, 10);
      }
    } catch (err) {
      console.error("Network error:", err);
    }
    return null;
  }

  function showMovieOptions(options, isBulk = false) {
    const modal = document.getElementById("movieModal");
    const container = document.getElementById("movieOptions");
    
    container.innerHTML = "";
    
    // Add skip button for bulk imports
    if (isBulk) {
      const skipBtn = document.createElement("button");
      skipBtn.className = "button-secondary";
      skipBtn.style.width = "100%";
      skipBtn.style.marginBottom = "16px";
      skipBtn.innerHTML = "‚äò Skip This Movie";
      skipBtn.onclick = () => {
        closeModal();
        processBulkQueue();
      };
      
      const container_parent = document.querySelector('.modal-content');
      if (container_parent) {
        const existing_skip = container_parent.querySelector('[style*="width: 100%"]');
        if (!existing_skip) {
          container.parentElement.insertBefore(skipBtn, container);
        }
      }
    }
    
    options.forEach(movie => {
      const box = document.createElement("div");
      box.className = "movie-option";
      box.innerHTML = `<div class="movie-option-title">${movie.Title}</div><div class="movie-option-year">${movie.Year}</div>`;
      box.onclick = () => {
        const fullTitle = `${movie.Title} (${movie.Year})`;
        const duplicate = movies.find(m => m.toLowerCase() === fullTitle.toLowerCase()) ||
                         bulkAdded.find(m => m.toLowerCase() === fullTitle.toLowerCase());
        if (!duplicate) {
          if (isBulk) {
            bulkAdded.push(fullTitle);
            closeModal();
            processBulkQueue();
          } else {
            movies.push(fullTitle);
            saveMovies();
            render();
            showNotification(`Added "${fullTitle}"`, 'success');
            closeModal();
          }
        } else {
          showNotification(`"${fullTitle}" is already in your list!`, 'warning');
        }
      };
      container.appendChild(box);
    });
    
    modal.classList.add('active');
  }

  async function addMovie() {
    const input = document.getElementById("movieInput");
    const movieTitle = input.value.trim();
    
    if (!movieTitle) return;
    
    // Check for similar movies
    const similar = findSimilarMovies(movieTitle);
    if (similar.length > 0) {
      const exactMatch = similar.find(item => item.similarity === 100);
      if (exactMatch) {
        showNotification(`"${exactMatch.movie}" is already in your list!`, 'warning');
        input.value = "";
        return;
      }
      
      // Show warning about similar movie
      const similar95 = similar.find(item => item.similarity >= 95);
      if (similar95) {
        showNotification(`Similar to "${similar95.movie}" - adding anyway!`, 'warning');
      }
    }
    
    const yearMatch = movieTitle.match(/\((\d{4})\)$/);
    
    if (yearMatch) {
      movies.push(movieTitle);
      input.value = "";
      saveMovies();
      render();
      showNotification(`Added "${movieTitle}"`, 'success');
    } else {
      const versions = await checkForMultipleVersions(movieTitle);
      if (versions && versions.length > 0) {
        input.value = "";
        showMovieOptions(versions, false);
      } else {
        movies.push(movieTitle);
        input.value = "";
        saveMovies();
        render();
        showNotification(`Added "${movieTitle}"`, 'success');
      }
    }
  }

  async function processBulkQueue() {
    if (bulkQueue.length === 0) {
      flushBulkCommit();
      return;
    }
    
    const rawTitle = bulkQueue.shift();
    
    // Check for similar movies
    const similar = findSimilarMovies(rawTitle);
    if (similar.length > 0 && similar[0].similarity === 100) {
      // Exact match - skip
      processBulkQueue();
      return;
    }
    
    const options = await checkForMultipleVersions(rawTitle);
    
    if (options && options.length > 1) {
      showMovieOptions(options, true);
    } else {
      const chosen = options ? `${options[0].Title} (${options[0].Year})` : rawTitle;
      const dup = movies.find(m => m.toLowerCase() === chosen.toLowerCase()) ||
                  bulkAdded.find(m => m.toLowerCase() === chosen.toLowerCase());
      if (!dup) bulkAdded.push(chosen);
      processBulkQueue();
    }
  }

  function flushBulkCommit() {
    if (bulkAdded.length === 0) return;
    movies.push(...bulkAdded);
    saveMovies();
    render();
    showNotification(`Added ${bulkAdded.length} movie${bulkAdded.length !== 1 ? 's' : ''}`, 'success');
    bulkAdded = [];
  }

  async function addMultiple() {
    const textarea = document.getElementById("multiInput");
    const lines = textarea.value.split("\n").map(m => m.trim()).filter(m => m);
    
    if (lines.length === 0) return;
    
    bulkQueue = lines;
    bulkAdded = [];
    textarea.value = "";
    
    showNotification("Processing titles...", 'success');
    processBulkQueue();
  }

  function importFromFile() {
    const fileInput = document.getElementById("fileInput");
    const file = fileInput.files[0];
    
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = async function(e) {
      const lines = e.target.result.split("\n").map(m => m.trim()).filter(m => m);
      
      if (lines.length === 0) {
        showNotification("No movies found in file", 'warning');
        fileInput.value = "";
        return;
      }
      
      bulkQueue = lines;
      bulkAdded = [];
      fileInput.value = "";
      showNotification("File loaded, processing...", 'success');
      processBulkQueue();
    };
    reader.readAsText(file);
  }

  function downloadBackup(format = 'json') {
    if (movies.length === 0) {
      showNotification("No movies to backup", 'warning');
      return;
    }
    
    let dataStr, dataBlob, filename;
    
    if (format === 'txt') {
      dataStr = movies.join("\n");
      dataBlob = new Blob([dataStr], { type: 'text/plain' });
      filename = `cinepick-backup-${new Date().toISOString().split('T')[0]}.txt`;
    } else {
      const backup = {
        version: "1.0",
        exportDate: new Date().toISOString(),
        movieCount: movies.length,
        movies: movies
      };
      dataStr = JSON.stringify(backup, null, 2);
      dataBlob = new Blob([dataStr], { type: 'application/json' });
      filename = `cinepick-backup-${new Date().toISOString().split('T')[0]}.json`;
    }
    
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
    
    showNotification(`Backup saved (${movies.length} movies)`, 'success');
  }

  function restoreFromBackup() {
    const fileInput = document.getElementById("backupInput");
    const file = fileInput.files[0];
    
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        const content = e.target.result;
        let restoredMovies = [];
        
        try {
          const backup = JSON.parse(content);
          restoredMovies = backup.movies || backup || [];
        } catch {
          restoredMovies = content.split("\n").map(m => m.trim()).filter(m => m);
        }
        
        if (restoredMovies.length === 0) {
          showNotification("No movies found in backup", 'warning');
          fileInput.value = "";
          return;
        }
        
        if (confirm(`Replace ${movies.length} movies with ${restoredMovies.length}?`)) {
          movies = restoredMovies;
          saveMovies();
          render();
          showNotification(`Restored ${movies.length} movie${movies.length !== 1 ? 's' : ''}`, 'success');
          document.getElementById("resultSection").style.display = 'none';
          document.getElementById("detailsPanel").classList.remove('active');
        }
      } catch (error) {
        showNotification("Error reading backup file", 'warning');
      }
      fileInput.value = "";
    };
    reader.readAsText(file);
  }

  function removeMovie(index) {
    const deletedMovie = movies[index];
    deletedMovies.push({ movie: deletedMovie, index: index });
    if (deletedMovies.length > 10) deletedMovies.shift();
    
    movies.splice(index, 1);
    saveMovies();
    render();
    showNotification(`Removed "${deletedMovie}"`, 'success');
    updateUndoButton();
  }

  function updateUndoButton() {
    document.getElementById("undoBtn").disabled = deletedMovies.length === 0;
  }

  function undoDelete() {
    if (deletedMovies.length > 0) {
      const lastDeleted = deletedMovies.pop();
      movies.splice(lastDeleted.index, 0, lastDeleted.movie);
      saveMovies();
      render();
      showNotification(`Restored "${lastDeleted.movie}"`, 'success');
      updateUndoButton();
    }
  }

  function clearAllMovies() {
    if (movies.length === 0) return;
    if (!confirm(`Delete all ${movies.length} movies?`)) return;
    
    movies = [];
    saveMovies();
    render();
    updateUndoButton();
    document.getElementById("resultSection").style.display = 'none';
    document.getElementById("detailsPanel").classList.remove('active');
    showNotification('All movies removed', 'success');
  }

  function toggleList() {
    listVisible = !listVisible;
    const list = document.getElementById("movieList");
    const btn = document.getElementById("toggleBtn");
    const search = document.getElementById("searchInput");
    
    if (listVisible) {
      list.classList.add('visible');
      search.style.display = "block";
      btn.textContent = "Hide Movies";
    } else {
      list.classList.remove('visible');
      search.style.display = "none";
      btn.textContent = "Show Movies";
    }
    render();
  }

  async function fetchMovieDetails(movieTitle) {
    try {
      const yearMatch = movieTitle.match(/^(.+?)\s*\((\d{4})\)$/);
      let searchTitle = movieTitle;
      let searchYear = null;
      
      if (yearMatch) {
        searchTitle = yearMatch[1].trim();
        searchYear = yearMatch[2];
      }
      
      let url = `https://www.omdbapi.com/?t=${encodeURIComponent(searchTitle)}&apikey=${API_KEY}&plot=full`;
      if (searchYear) url += `&y=${searchYear}`;
      
      const response = await fetch(url);
      const data = await response.json();
      
      if (data.Response === "True") {
        return data;
      } else {
        const searchResponse = await fetch(`https://www.omdbapi.com/?s=${encodeURIComponent(searchTitle)}&apikey=${API_KEY}`);
        const searchData = await searchResponse.json();
        
        if (searchData.Search && searchData.Search.length > 0) {
          let firstResult = searchData.Search[0];
          if (searchYear) {
            const yearMatch = searchData.Search.find(m => m.Year === searchYear);
            if (yearMatch) firstResult = yearMatch;
          }
          
          const detailedResponse = await fetch(`https://www.omdbapi.com/?i=${firstResult.imdbID}&apikey=${API_KEY}&plot=full`);
          return await detailedResponse.json();
        }
      }
    } catch (err) {
      console.error("Error fetching movie details:", err);
    }
    return null;
  }

  function displayMovieDetails(details) {
    const panel = document.getElementById("detailsPanel");
    
    if (!details || details.Response === "False") {
      panel.innerHTML = `<div class="empty-state">‚ö†Ô∏è No details available</div>`;
      panel.classList.add('active');
      return;
    }
    
    const runtime = details.Runtime?.replace(" min", "") + " min" || "N/A";
    let ratingsHTML = "";
    
    if (details.imdbRating && details.imdbRating !== "N/A") {
      ratingsHTML += `<span class="rating-badge">IMDb: ${details.imdbRating}/10</span>`;
    }
    
    const genresHTML = details.Genre ? `<div class="genre-tags">${details.Genre.split(", ").map(g => `<span class="genre-tag">${g}</span>`).join("")}</div>` : "";
    
    panel.innerHTML = `
      <div class="details-grid">
        <div class="poster-container">
          ${details.Poster && details.Poster !== "N/A" 
            ? `<img src="${details.Poster}" alt="${details.Title}" class="poster-image">` 
            : `<div class="poster-placeholder">No poster available</div>`}
        </div>
        <div class="details-content">
          <h3>${details.Title} (${details.Year})</h3>
          
          <div class="info-row">
            <div class="info-label">Rating</div>
            <div class="info-value">${ratingsHTML || 'N/A'}</div>
          </div>
          
          <div class="info-row">
            <div class="info-label">Runtime</div>
            <div class="info-value">${runtime}</div>
          </div>
          
          <div class="info-row">
            <div class="info-label">Director</div>
            <div class="info-value">${details.Director || 'N/A'}</div>
          </div>
          
          <div class="info-row">
            <div class="info-label">Cast</div>
            <div class="info-value">${details.Actors || 'N/A'}</div>
          </div>
          
          <div class="info-row">
            <div class="info-label">Genre</div>
            <div class="info-value">${details.Genre || 'N/A'}</div>
          </div>
          
          ${genresHTML}
          
          <div class="info-row" style="border-bottom: none; flex-direction: column; align-items: flex-start;">
            <div class="info-label">Plot</div>
            <div class="plot-text">${details.Plot || 'No plot available'}</div>
          </div>
          
          ${details.imdbID ? `<a href="https://www.imdb.com/title/${details.imdbID}/" target="_blank" class="imdb-link">View on IMDb ‚Üí</a>` : ''}
        </div>
      </div>
    `;
    
    panel.classList.add('active');
  }

  async function pickRandom() {
    if (movies.length === 0) {
      showNotification("Add some movies first!", 'warning');
      return;
    }
    
    const btn = document.getElementById("pickBtn");
    btn.disabled = true;
    
    const resultSection = document.getElementById("resultSection");
    const resultBox = document.getElementById("resultBox");
    resultSection.style.display = 'block';
    resultBox.innerHTML = '<div class="spinner"></div>';
    
    setTimeout(async () => {
      const randomMovie = movies[Math.floor(Math.random() * movies.length)];
      
      resultBox.innerHTML = `<div><div class="result-label">Now Watching:</div><div class="result-title">${randomMovie}</div></div>`;
      
      const details = await fetchMovieDetails(randomMovie);
      displayMovieDetails(details);
      
      btn.disabled = false;
    }, 1200);
  }

  function render() {
    const list = document.getElementById("movieList");
    const searchTerm = document.getElementById("searchInput").value.toLowerCase();
    const filtered = movies.filter(m => m.toLowerCase().includes(searchTerm));
    
    if (filtered.length === 0 && listVisible) {
      list.innerHTML = '<div class="empty-state">No movies found</div>';
    } else {
      list.innerHTML = "";
      filtered.forEach((movie, idx) => {
        const actualIndex = movies.indexOf(movie);
        const div = document.createElement("div");
        div.className = "movie-item";
        div.innerHTML = `<span>${movie}</span><button onclick="removeMovie(${actualIndex})" title="Remove">‚úï</button>`;
        list.appendChild(div);
      });
    }
    
    // Update movie count badge
    document.getElementById("movieCountBadge").textContent = movies.length;
    
    // Update recently added section
    const recentSection = document.getElementById("recentlyAddedSection");
    const recentList = document.getElementById("recentlyAddedList");
    
    if (movies.length > 0) {
      const recentMovies = movies.slice(-5).reverse(); // Last 5 movies, reversed
      recentSection.style.display = "block";
      recentList.innerHTML = "";
      
      recentMovies.forEach((movie) => {
        const tag = document.createElement("span");
        tag.style.cssText = `
          background: var(--bg-card-hover);
          border: 1px solid var(--border);
          padding: 6px 12px;
          border-radius: 6px;
          font-size: 0.9rem;
          display: inline-block;
        `;
        tag.textContent = movie;
        recentList.appendChild(tag);
      });
    } else {
      recentSection.style.display = "none";
    }
    
    document.getElementById("clearBtn").disabled = movies.length === 0;
  }

  updateUndoButton();
  
  // Initialize IndexedDB and load data
  (async function() {
    try {
      await initDB();
      
      // Load movies from IndexedDB
      await loadMoviesFromDB();
      
      // If no data in IndexedDB, try to migrate from localStorage
      if (movies.length === 0) {
        const oldData = localStorage.getItem("movies");
        if (oldData) {
          try {
            movies = JSON.parse(oldData);
            await saveMoviesToDB();
            console.log("Migrated movies from localStorage to IndexedDB");
          } catch (e) {
            console.error("Error migrating data:", e);
          }
        }
      }
      
      render();
    } catch (err) {
      console.error("Failed to initialize IndexedDB, using localStorage fallback:", err);
      // Fallback to localStorage if IndexedDB fails
      movies = JSON.parse(localStorage.getItem("movies")) || [];
      render();
    }
  })();
</script>

</body>
</html>
